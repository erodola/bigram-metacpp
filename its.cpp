#include <iostream>
#include <array>
#include <limits>
#include <cstdint>

static constexpr size_t ROWS = 27;
static constexpr size_t COLS = 27;

// xorshift32 rng (approximately uniform)
struct Xorshift {
    static constexpr uint32_t next(uint32_t state) {
        if (state == 0) state = 0xdeadbeef; 
        state ^= state << 13;
        state ^= state >> 17;
        state ^= state << 5;
        return state;
    }
    static constexpr uint32_t max_val = std::numeric_limits<uint32_t>::max();
};

// sampler
template <size_t Rows, size_t Cols, size_t SampleCount>
struct MultinomialSampler {
    int samples[SampleCount];
    uint32_t next_seed;

    static constexpr int pick_index(double u, const double cdf[Cols]) {
        for (size_t i = 0; i < Cols; ++i) {
            if (u <= cdf[i]) return static_cast<int>(i);
        }
        return static_cast<int>(Cols - 1);
    }

    constexpr MultinomialSampler(uint32_t seed, const double matrix[Rows][Cols], size_t row_index) : samples{}, next_seed(seed) {

        // cool trick: throw is not allowed at compile time, so the compiler will fail if the throw path is reached
        if (row_index >= Rows)
            throw "Index Out of Bounds";

        // normalize row into a CDF
        double sum = 0;
        for (size_t i = 0; i < Cols; ++i) sum += matrix[row_index][i];

        double cdf[Cols] = {};
        double cumulative = 0;
        for (size_t i = 0; i < Cols; ++i) {
            cumulative += (sum > 0) ? (matrix[row_index][i] / sum) : 0;
            cdf[i] = cumulative;
        }

        // generate samples
        uint32_t current_state = seed;
        for (size_t i = 0; i < SampleCount; ++i) {
            current_state = Xorshift::next(current_state);
            double u = static_cast<double>(current_state) / static_cast<double>(Xorshift::max_val);
            samples[i] = pick_index(u, cdf);
        }
        next_seed = current_state;
    }
};

// token index to char
constexpr char itos(int index) {
    if (index == 0) return '.';
    if (index >= 1 && index <= 26) return static_cast<char>('a' + (index - 1));
    return '?';
}

// FNV-1a constants for 32-bit hash
constexpr uint32_t fnv_offset_basis = 0x811c9dc5;
constexpr uint32_t fnv_prime = 0x01000193;

constexpr uint32_t hash_time_date(const char* time_str, const char* date_str) {
    uint32_t hash = fnv_offset_basis;

    // hash the time string "HH:MM:SS"
    while (*time_str) {
        hash ^= static_cast<uint32_t>(*time_str++);
        hash *= fnv_prime;
    }

    // hash the date string "Mmm dd yyyy"
    while (*date_str) {
        hash ^= static_cast<uint32_t>(*date_str++);
        hash *= fnv_prime;
    }

    return hash;
}

template <size_t MaxLength>
struct NameGenerator {
    char name[MaxLength + 1]; // +1 for null terminator
    size_t actual_length;

    constexpr NameGenerator(uint32_t seed, const double matrix[ROWS][COLS]) 
        : name{}, actual_length(0) 
    {
        uint32_t state = seed;
        size_t current_row = 0; // start at '.' context
        bool finished = false;

        for (size_t i = 0; i < MaxLength; ++i) {
            if (finished) {
                name[i] = '\0'; 
                continue;
            }

            // cumulate on the current row
            double sum = 0;
            for (size_t j = 0; j < COLS; ++j) sum += matrix[current_row][j];

            // sample next character
            state = Xorshift::next(state);
            double u = static_cast<double>(state) / static_cast<double>(Xorshift::max_val);

            double cumulative = 0;
            size_t next_idx = 0;
            for (size_t j = 0; j < COLS; ++j) {
                cumulative += (sum > 0) ? (matrix[current_row][j] / sum) : 0;
                if (u <= cumulative) {
                    next_idx = j;
                    break;
                }
            }

            // check for termination (index 0 is '.')
            if (next_idx == 0) {
                finished = true;
                name[i] = '\0';
            } else {
                name[i] = itos(next_idx);
                current_row = next_idx;
                actual_length++;
            }
        }
        name[MaxLength] = '\0';
    }
};


int main() {

    static constexpr double T[ROWS][COLS] = {
        {0.0,0.13767053,0.040770456,0.04813786,0.052758094,0.04779446,0.013017826,0.020884713,0.027284363,0.018449724,0.07560953,0.09249836,0.049074393,0.07923079,0.035775606,0.012299816,0.01607717,0.0028720382,0.051165987,0.06415259,0.040832892,0.002434989,0.011737895,0.009583866,0.004183186,0.016701527,0.029001342},
        {0.19595692,0.01640844,0.015965767,0.013870444,0.03075107,0.020422015,0.003954552,0.004957946,0.06882101,0.04869411,0.005164527,0.016762579,0.074605286,0.048221927,0.16048399,0.0018592298,0.0024199497,0.001770695,0.09632581,0.03299395,0.020274458,0.011243913,0.02461266,0.0047513647,0.005371108,0.060498744,0.0128375385},
        {0.04310019,0.12136106,0.01436673,0.00037807183,0.02457467,0.24763705,0.0,0.0,0.015500945,0.08204159,0.00037807183,0.0,0.0389414,0.0,0.0015122873,0.039697543,0.0,0.0,0.3183365,0.0030245746,0.00075614365,0.017013233,0.0,0.0,0.0,0.03137996,0.0},
        {0.027463194,0.23074745,0.0,0.011891279,0.0002831257,0.15600227,0.0,0.0005662514,0.18799546,0.07672707,0.00084937713,0.08946773,0.032842584,0.0,0.0,0.10758777,0.0002831257,0.0031143827,0.021517554,0.0014156286,0.0099094,0.0099094,0.0,0.0,0.00084937713,0.029445074,0.0011325028},
        {0.093886465,0.23708151,0.00018195051,0.00054585154,0.027110625,0.2334425,0.00090975256,0.004548763,0.02147016,0.12263464,0.0016375546,0.00054585154,0.01091703,0.005458515,0.0056404658,0.06877729,0.0,0.00018195051,0.077147014,0.005276565,0.00072780205,0.016739447,0.0030931586,0.0041848617,0.0,0.057678312,0.00018195051},
        {0.19502522,0.03324683,0.005924693,0.0074915537,0.01880233,0.062233757,0.004015081,0.0061205504,0.0074425894,0.040052883,0.0026930422,0.008715664,0.15903638,0.037653625,0.13097978,0.013171424,0.0040640454,0.00068550167,0.0958723,0.04215835,0.028399354,0.0033785438,0.022670519,0.00244822,0.0064633014,0.052391913,0.008862557},
        {0.08839779,0.2674033,0.0,0.0,0.0,0.1359116,0.048618786,0.0011049723,0.0011049723,0.17679559,0.0,0.0022099447,0.022099448,0.0,0.0044198893,0.06629834,0.0,0.0,0.12596685,0.0066298344,0.019889502,0.011049724,0.0,0.0044198893,0.0,0.0154696135,0.0022099447},
        {0.056045666,0.17125064,0.0015568241,0.0,0.009859886,0.17332642,0.0005189414,0.012973534,0.18681888,0.09859886,0.0015568241,0.0,0.016606124,0.0031136482,0.014011417,0.043072134,0.0,0.0,0.10430721,0.015568241,0.016087182,0.044110015,0.0005189414,0.013492475,0.0,0.016087182,0.0005189414},
        {0.31630778,0.29464287,0.0010504202,0.00026260506,0.0031512605,0.0884979,0.00026260506,0.00026260506,0.00013130253,0.09571954,0.0011817227,0.003807773,0.024290966,0.015362395,0.018119749,0.037683822,0.00013130253,0.00013130253,0.026785715,0.0040703784,0.009322479,0.021796219,0.0051207985,0.0013130252,0.0,0.027967436,0.0026260505},
        {0.14061353,0.13812779,0.0062143384,0.028755438,0.024857353,0.09338456,0.005705892,0.024179425,0.0053669284,0.0046325065,0.004293543,0.025139822,0.07598441,0.024122931,0.120106205,0.033218462,0.0029941811,0.002937687,0.047963392,0.07434608,0.030563245,0.0061578443,0.015196881,0.00045195187,0.0050279647,0.044008814,0.015648833},
        {0.024482759,0.50793105,0.0003448276,0.0013793104,0.0013793104,0.15172414,0.0,0.0,0.015517241,0.041034482,0.0006896552,0.0006896552,0.0031034483,0.0017241379,0.0006896552,0.16517241,0.0003448276,0.0,0.0037931034,0.002413793,0.0006896552,0.06965517,0.0017241379,0.0020689655,0.0,0.0034482758,0.0},
        {0.07202381,0.3434524,0.0003968254,0.0003968254,0.0003968254,0.17757936,0.0001984127,0.0,0.0609127,0.10099206,0.0003968254,0.003968254,0.027579365,0.0017857143,0.0051587303,0.06825397,0.0,0.0,0.021626985,0.018849207,0.003373016,0.009920635,0.0003968254,0.006746032,0.0,0.07519841,0.0003968254},
        {0.09413956,0.1879209,0.0037254621,0.0017910876,0.009886803,0.20927067,0.001576157,0.00042986101,0.0013612265,0.17767589,0.00042986101,0.0017194441,0.09636051,0.00429861,0.001003009,0.049577303,0.0010746525,0.00021493051,0.001289583,0.006734489,0.0055165496,0.023212494,0.005158332,0.001146296,0.0,0.11376988,0.000716435},
        {0.07768744,0.3899428,0.01686239,0.00767841,0.0036133695,0.123155676,0.00015055705,0.0,0.0007527853,0.18909967,0.0010538994,0.00015055705,0.0007527853,0.025293587,0.0030111412,0.06805179,0.005721168,0.0,0.014604035,0.005269497,0.0006022282,0.020927431,0.0004516712,0.0003011141,0.0,0.043209877,0.0016561276},
        {0.36901838,0.16243793,0.00043651444,0.011622197,0.03841327,0.07415289,0.00060020736,0.014896055,0.0014186719,0.09412342,0.0024008295,0.0031647296,0.010640039,0.0010367217,0.10399956,0.027063895,0.00027282152,0.00010912861,0.0024008295,0.015168876,0.024171988,0.005238173,0.0030010368,0.00060020736,0.00032738582,0.0253724,0.007911824},
        {0.10776405,0.018779935,0.017645575,0.014368541,0.023947567,0.016637258,0.004285354,0.0055457526,0.02155281,0.008696748,0.0020166372,0.008570708,0.07801865,0.032896396,0.30388203,0.01449458,0.011973783,0.0003781195,0.13347618,0.063524075,0.0148727,0.034660954,0.02218301,0.014368541,0.005671792,0.012982102,0.0068061505},
        {0.032163743,0.2037037,0.0019493178,0.0009746589,0.0,0.1920078,0.0009746589,0.0,0.19883041,0.05945419,0.0009746589,0.0009746589,0.015594542,0.0009746589,0.0009746589,0.057504874,0.038011696,0.0,0.1471735,0.015594542,0.0165692,0.0038986355,0.0,0.0,0.0,0.0116959065,0.0},
        {0.10294118,0.04779412,0.0,0.0,0.0,0.0036764706,0.0,0.0,0.0,0.04779412,0.0,0.0,0.0036764706,0.007352941,0.0,0.007352941,0.0,0.0,0.0036764706,0.007352941,0.0,0.75735295,0.0,0.011029412,0.0,0.0,0.0},
        {0.1084252,0.18551181,0.0032283464,0.0077952757,0.014724409,0.13362205,0.0007086614,0.005984252,0.009527559,0.2388189,0.001968504,0.007086614,0.032519683,0.012755905,0.011023622,0.06842519,0.0011023622,0.0012598425,0.033464566,0.01496063,0.016377952,0.01984252,0.0062992126,0.0016535433,0.00023622047,0.060866144,0.0018110236},
        {0.14421417,0.14816186,0.0025906735,0.0074019246,0.0011102887,0.10905502,0.0002467308,0.0002467308,0.15852454,0.08438194,0.0002467308,0.010115963,0.034418948,0.011102887,0.0029607697,0.06550703,0.006291636,0.0001233654,0.0067850975,0.05687145,0.09437454,0.0228226,0.0017271157,0.0029607697,0.0,0.026523562,0.0012336541},
        {0.08671454,0.1843806,0.0001795332,0.0030520647,0.0,0.12854578,0.0003590664,0.0003590664,0.116157986,0.09551167,0.0005385996,0.0,0.02405745,0.0007181328,0.0039497307,0.11974865,0.0,0.0,0.06319569,0.0062836623,0.06714542,0.014003591,0.0026929982,0.0019748653,0.0003590664,0.061220825,0.018850988},
        {0.049441785,0.05199362,0.032854866,0.032854866,0.04338118,0.053907495,0.006060606,0.014992026,0.018500797,0.038596492,0.00446571,0.029665072,0.096012756,0.049122807,0.0877193,0.0031897926,0.005103668,0.0031897926,0.13205741,0.15119617,0.0261563,0.0009569378,0.011802233,0.027432216,0.010845295,0.0041467305,0.014354067},
        {0.03420132,0.24951419,0.0003886514,0.0,0.0003886514,0.22075398,0.0,0.0,0.0003886514,0.3540614,0.0,0.0011659542,0.0054411194,0.0,0.003109211,0.05946366,0.0,0.0,0.018655267,0.0,0.0,0.0027205597,0.0027205597,0.0,0.0,0.047026817,0.0},
        {0.05489774,0.30139935,0.0010764262,0.0,0.00861141,0.16038752,0.0021528525,0.0010764262,0.024757804,0.15931109,0.0,0.0064585577,0.013993542,0.0021528525,0.062432725,0.038751345,0.0,0.0,0.023681378,0.021528525,0.00861141,0.026910657,0.0,0.0021528525,0.0,0.07857912,0.0010764262},
        {0.23529412,0.14777619,0.0014347202,0.005738881,0.007173601,0.051649928,0.004304161,0.0,0.0014347202,0.14634146,0.0,0.0,0.055954088,0.0014347202,0.0014347202,0.05882353,0.0,0.0,0.0,0.044476327,0.100430414,0.007173601,0.0,0.004304161,0.05451937,0.043041606,0.027259685},
        {0.20529869,0.21921031,0.0027618657,0.011763503,0.027823241,0.030789688,0.001227496,0.0030687398,0.0022504092,0.019639935,0.0023527006,0.008797054,0.11292962,0.015139116,0.18678395,0.027720949,0.0015343699,0.000613748,0.029766776,0.04101882,0.010638298,0.014423077,0.01084288,0.0004091653,0.002864157,0.0023527006,0.007978723},
        {0.06672227,0.3586322,0.0016680567,0.00083402835,0.00083402835,0.1555463,0.0,0.00041701418,0.01793161,0.15179317,0.00083402835,0.00083402835,0.051292744,0.0145954965,0.0016680567,0.04587156,0.00083402835,0.0,0.013344454,0.0016680567,0.0016680567,0.030442035,0.00083402835,0.0012510426,0.00041701418,0.061301086,0.018765638}
    };

    static constexpr uint32_t seed = hash_time_date(__TIME__, __DATE__);
    
    static constexpr NameGenerator<15> result(seed, T);
    std::cout << "Generated Name: " << result.name << std::endl;

    return 0;
}